<!--
/**
 * 
 * Apoyar
 *
 * DISCLAIMER
 *
 * Please do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 * 
 * @category   Apoyar
 * @package    Apoyar_ProductRules
 * @copyright  Copyright (c) 2023 Apoyar (http://www.apoyar.eu/)
 */
-->
<div class="entry-edit form-inline pda-messages">
    <fieldset class="fieldset admin__fieldset pda_message_fieldset" id="pda_message_fieldset">
        <?php $id = $block->getRequest()->getParam('id');?>
        <?php $display = 1; ?>
        <?php $attributeList = $block->getAttributeResource(); ?>
        <?php $ruleCount = 0;?>
        <?php if (isset($id)): ?>
            <?php $messages = $block->getRuleById($id); ?>
            <?php if ($messages):?>
                <?php $rules = unserialize($messages->getData('rules'));?>
                <?php $ruleCount = count($rules);?>
                <?php if (count($rules) > 0):?>
                    <?php $i =0 ;?>
                    <?php foreach ($rules as $key => $attribute_code): ?>
                        <?php $display = 0; ?>
                        <?php $attrType = '';?>
                        <div class="clonediv">
                            <div class="admin__field field">
                                <label class="label admin__field-label" for="item_cutoff_time" ><span>Attribute</span></label>
                                <div class="admin__field-control control">
                                    <select name="rules[<?= $i; ?>][attribute_code]" title="Attribute"  class="input-text admin__control-text attribute-code ajax-update" style="">
                                        <option value="">--choose--</option>
                                        <?php  foreach ($attributeList->getItems() as $items):?>
                                            <option <?php if ($items->getAttributeCode() == $attribute_code['attribute_code']):?> selected="selected" <?php endif;?> value="<?= $items->getAttributeCode() ;?>"><?= $items->getFrontendLabel();?></option>
                                        <?php endforeach;?>
                                    </select>
                                </div>
                            </div>
                            <div class="admin__field field">
                                <label class="label admin__field-label" for="item_cutoff_time" ><span>Value</span></label>
                                <div class="admin__field-control control replace-dynamic ">
                                    <?php $valueField='';?>
                                    <?php $eavAttribute = $block->getAttributeByAttributeCode($attribute_code['attribute_code']);

                                    if ($eavAttribute->getFrontendInput() == "boolean" || $eavAttribute->getFrontendInput() == "select" || $eavAttribute->getFrontendInput() == "multiselect") {
                                        $multiple = '';
                                        $name = "rules[$i][value]";
                                        if ($eavAttribute->getFrontendInput() == "multiselect") {
                                            $multiple = "multiple";
                                            $name = "rules[$i][value][]";
                                        }
                                        $options = $eavAttribute->getSource()->getAllOptions();
                                        $valueField = '<select name="'.$name.'" '.$multiple.'  title="Attribute"  class="input-text admin__control-text attribute-value" style="">';
                                        foreach ($options as $opt) {
                                            $selected = '';
                                            if (isset($attribute_code['value'])) {
                                                if (is_array($attribute_code['value'])) {
                                                    if (in_array($opt['value'], $attribute_code['value'])) {
                                                        $selected = "selected";
                                                    }
                                                } elseif ($opt['value'] ==  $attribute_code['value']) {
                                                    $selected = "selected";
                                                }
                                            }
                                            $valueField .= '<option '.$selected.'  value="'.$opt['value'].'">'.$opt['label'].'</option>';
                                        }
                                        $valueField .= '</select>';
                                    } elseif ($eavAttribute->getFrontendInput() == "weight"
                                        || $eavAttribute->getFrontendInput() == "date"
                                        || $eavAttribute->getFrontendInput() == "decimal"
                                        || $eavAttribute->getFrontendInput() == "text"
                                        || $eavAttribute->getFrontendInput() == "price") {

                                        $valueField = '<input name="rules['.$i.'][value]" value="'.$attribute_code['value'].'" title="Value" type="text" class="input-text admin__control-text attribute-value" style="">';

                                    } elseif ($eavAttribute->getFrontendInput() == "textarea") {
                                        $valueField = '<textarea name="rules['.$i.'][value]"  title="Value" class="textarea" rows="3" cols="3" aria-hidden="true" style="">'.$attribute_code['value'].'</textarea>';
                                    }
                                    ?>
                                    <?= $valueField;?>
                                </div>
                                &nbsp;
                                <?php if (isset($id)): ?>
                                    <button title="Delete Message" type="button" class="action-default scalable deletemessage save primary ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                            <span class="ui-button-text">
                                <span>Delete</span>
                            </span>
                                    </button>
                                <?php endif; ?>
                                <button title="Add Message" style="display: none" type="button" class="action-default scalable addmore ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                            <span class="ui-button-text">
                                <span>Add</span>
                            </span>
                                </button>
                                <hr><br/>
                            </div>
                        </div>
                        <?php $i++;?>
                    <?php endforeach;?>
                <?php endif;?>
            <?php endif?>
        <?php endif; ?>
        <div class="clonediv">
            <div class="admin__field field">
                <label class="label admin__field-label" for="item_cutoff_time" ><span>Attribute</span></label>
                <div class="admin__field-control control">
                    <select name="rules[<?= $ruleCount; ?>][attribute_code]" title="Attribute"  class="input-text admin__control-text attribute-code" style="">
                        <option value="">--choose--</option>
                        <?php  foreach ($attributeList->getItems() as $items):?>
                            <option value="<?= $items->getAttributeCode() ;?>"><?= $items->getFrontendLabel();?></option>
                        <?php endforeach;?>
                    </select>
                </div>
            </div>
            <div class="admin__field field">
                <label class="label admin__field-label" for="item_cutoff_time" ><span>Value</span></label>
                <div class="admin__field-control control replace-dynamic">
                    <input name="rules[<?= $ruleCount; ?>][value]" value="" title="Value" type="text" class="input-text admin__control-text attribute-value" style="">
                </div>
                &nbsp;
                <?php if (isset($id)): ?>
                    <button title="Delete Message" type="button" class="action-default scalable deletemessage save primary ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                <span class="ui-button-text">
                    <span>Delete</span>
                </span>
                    </button>
                <?php endif; ?>
                <button  title="Add Message"  type="button" class="action-default scalable addmore ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                <span class="ui-button-text">
                    <span>Add</span>
                </span>
                </button>
                <hr><br/>
            </div>
        </div>

    </fieldset>
</div>
<script type="text/javascript">
    require(["jquery"],function($) {
        $(document).ready(function() {
            $('.pda-messages').hide();
            var mesages = $('.pda-messages').html();
            $('#rule_attribute_matching').find('.messages').append(mesages);
            $(document).on('change', '.attribute-code',function(){
                var attributeCode = $(this).val();
                var ddlObject = $(this);
                if(attributeCode!=""){
                    var customurl = "<?= $block->getBaseUrl().'apoyarfrontend/search'?>";
                    var itemItem = $(this).parents('.clonediv').index();
                    $.ajax({
                        url: customurl,
                        type: 'GET',
                        dataType: 'json',
                        data: {
                            attribute_code: $(this).val(),
                            row_index: $(this).parents('.clonediv').index(),
                            current_value: 'hee'
                        },

                        complete: function(response) {
                            console.log(response.responseJSON);
                            var jsonResponse = response.responseJSON;
                            ddlObject.attr('name','rules['+itemItem+'][attribute_code]');
                            if (jsonResponse.field != "null"){
                                ddlObject.parents('.clonediv').find('.replace-dynamic').html(jsonResponse.field);
                            }
                        },
                        error: function (xhr, status, errorThrown) {
                            console.log('Error happens. Try again.');
                        }
                    });
                }
            });

            if($('#rules_edit_tabs_actions_section_content').find('.addmore').length) {
                $('#rules_edit_tabs_actions_section_content').on('click','button.addmore',function () {
                    $('#rules_edit_tabs_actions_section_content .deletemessage').each(function(){
                        $(this).show();
                    });
                    if($('#rules_edit_tabs_actions_section_content').find('.clonediv:first').length > 0){
                        var divhtml = $('#rules_edit_tabs_actions_section_content').find('.clonediv:first').html();
                        $('#rules_edit_tabs_actions_section_content').find('.clonediv:last').parent().append('<div class="clonediv">'+divhtml + '</div>');
                    }
                    var check = 1;
                    var len = $('#rules_edit_tabs_actions_section_content .addmore').length;

                    $('#rules_edit_tabs_actions_section_content .addmore').each(function(){

                        if(check == len){
                            $(this).show();
                        }else{
                            $(this).hide();
                        }
                        check++;
                    });

                    var check = 1;
                    $('#rules_edit_tabs_actions_section_content .deletemessage').each(function(){
                        if(check == 1 && len == 1){
                            $(this).hide();
                        }
                        check++;
                    });
                    $(".attribute-code").bind('change');
                });

            }

            if($('#rules_edit_tabs_actions_section_content').find('.deletemessage').length  == 1)
                $('#rules_edit_tabs_actions_section_content').find('.deletemessage').hide();
            if($('#rules_edit_tabs_actions_section_content').find('.deletemessage').length) {
                $('#rules_edit_tabs_actions_section_content').on('click','.deletemessage',function () {

                    $('#rules_edit_tabs_actions_section_content .addmore').each(function(){
                        $(this).show();
                    });
                    $('#rules_edit_tabs_actions_section_content .deletemessage').each(function(){
                        $(this).show();
                    });

                    $(this).parents('.clonediv').remove();

                    var check = 1;
                    var len = $('#rules_edit_tabs_actions_section_content').find('.deletemessage').length;
                    $('#rules_edit_tabs_actions_section_content').find('.addmore').each(function(){
                        if(check == len){
                            $(this).show();
                        }else{
                            $(this).hide();
                        }
                        check++;
                    });

                    var check = 1;
                    $('#rules_edit_tabs_actions_section_content').find('.deletemessage').each(function(){
                        if(check == 1 && len == 1){
                            $(this).hide();
                        }
                        check++;
                    });
                });
            }
        });
    });
</script>